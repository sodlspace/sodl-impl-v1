---
---

<!-- Modal backdrop (hidden by default, triggered by keyboard shortcut or external button) -->
<div
  id="search-modal"
  class="search-modal hidden fixed inset-0 z-50 flex items-start justify-center bg-black/70 backdrop-blur-sm pt-20"
  role="dialog"
  aria-modal="true"
  aria-labelledby="search-modal-title"
>
  <!-- Modal content -->
  <div
    class="w-full max-w-2xl rounded-xl border border-neutral-700 bg-neutral-900 shadow-2xl"
    onclick={(e) => e.stopPropagation()}
  >
    <!-- Pagefind UI renders everything here -->
    <div id="search-ui"></div>
    <div class="border-t border-neutral-800 px-4 py-2 text-xs text-neutral-500 flex items-center gap-4">
      <span><kbd class="rounded bg-neutral-800 px-1.5 py-0.5 font-mono">↑↓</kbd> to navigate</span>
      <span><kbd class="rounded bg-neutral-800 px-1.5 py-0.5 font-mono">Enter</kbd> to select</span>
      <span><kbd class="rounded bg-neutral-800 px-1.5 py-0.5 font-mono">Esc</kbd> to close</span>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('search-modal');

  let pagefindUI: any = null;
  let isInitialized = false;

  async function initPagefind() {
    if (isInitialized) return;
    
    const { PagefindUI } = await import('@pagefind/default-ui');
    
    // Initialize Pagefind UI with explicit bundle path
    pagefindUI = new PagefindUI({
      element: '#search-ui',
      showSubResults: true,
      resetStyles: true,
      bundlePath: '/sodl-impl-v1/pagefind/',
      translations: {
        placeholder: 'Search documentation...',
      },
    });
    
    isInitialized = true;
  }

  async function openSearch() {
    await initPagefind();
    modal?.classList.remove('hidden');
    
    // Focus the search input after a short delay
    setTimeout(() => {
      const input = document.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
      input?.focus();
    }, 50);
  }

  function closeSearch() {
    modal?.classList.add('hidden');
  }

  function handleKeydown(event: KeyboardEvent) {
    const isModalHidden = modal?.classList.contains('hidden');

    if ((event.metaKey || event.ctrlKey) && event.key === 'k') {
      event.preventDefault();
      if (isModalHidden) {
        openSearch();
      } else {
        closeSearch();
      }
    }
    if (event.key === 'Escape' && !isModalHidden) {
      closeSearch();
    }
  }

  // Initialize - listen for custom event and keyboard shortcuts
  document.addEventListener('open-search', (e) => {
    e.preventDefault();
    openSearch();
  });

  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeSearch();
    }
  });

  document.addEventListener('keydown', handleKeydown);
</script>

<style>
  /* Pagefind UI customizations for dark theme */
  :global(.pagefind-ui) {
    width: 100%;
    padding: 0;
  }

  :global(.pagefind-ui__search-container) {
    border-bottom: 1px solid #262626 !important;
    padding: 1rem 1rem 0.75rem 1rem !important;
    margin: 0 !important;
  }

  :global(.pagefind-ui__search-input) {
    width: 100% !important;
    background: transparent !important;
    border: none !important;
    color: #ffffff !important;
    font-size: 1rem !important;
    outline: none !important;
    padding: 0.5rem 0 !important;
    -webkit-text-fill-color: #ffffff !important;
  }

  :global(.pagefind-ui__search-input::placeholder) {
    color: #737373 !important;
    -webkit-text-fill-color: #737373 !important;
  }

  :global(.pagefind-ui__search-icon) {
    color: #737373 !important;
  }

  :global(.pagefind-ui__drawer) {
    max-height: 50vh;
    overflow-y: auto;
    padding: 1rem !important;
  }

  :global(.pagefind-ui__result) {
    border-radius: 0.5rem;
    padding: 0.75rem !important;
    margin-bottom: 0.5rem !important;
    background: transparent !important;
  }

  :global(.pagefind-ui__result:hover) {
    background: #171717 !important;
  }

  :global(.pagefind-ui__result-link) {
    color: #fff !important;
    font-size: 0.95rem;
    font-weight: 600;
    text-decoration: none !important;
  }

  :global(.pagefind-ui__result-link:hover) {
    text-decoration: underline !important;
  }

  :global(.pagefind-ui__result-excerpt) {
    color: #a3a3a3 !important;
    font-size: 0.8rem;
    margin-top: 0.5rem !important;
  }

  :global(.pagefind-ui__button) {
    background: #4f46e5 !important;
    color: #fff !important;
    border: none !important;
    border-radius: 0.375rem;
    padding: 0.375rem 0.75rem !important;
    font-size: 0.875rem !important;
    cursor: pointer !important;
  }

  :global(.pagefind-ui__button:hover) {
    background: #6366f1 !important;
  }

  :global(.pagefind-ui__clear-search) {
    display: none !important;
  }
</style>
